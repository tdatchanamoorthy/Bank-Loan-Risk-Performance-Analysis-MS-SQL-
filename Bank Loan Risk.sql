CREATE DATABASE BANK_LOAN_RISK

CREATE TABLE CUSTOMERS (
    CUSTOMER_ID INT PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(50),
    AGE INT,
    GENDER VARCHAR(10),
    CITY VARCHAR(30),
    CREDIT_SCORE INT,
    ANNUAL_INCOME INT
)

INSERT INTO CUSTOMERS VALUES
(1,'DATCHANA',22,'MALE','ARAKKONAM',720,600000),
(2,'ANITHA',28,'FEMALE','BANGALORE',680,450000),
(3,'KARTHIK',45,'MALE','COIMBATORE',750,900000),
(4,'PRIYA',35,'FEMALE','CHENNAI',610,400000),
(5,'ARUN',40,'MALE','MADURAI',590,350000),
(6,'MEENA',29,'FEMALE','TRICHY',700,500000),
(7,'SURESH',50,'MALE','SALEM',640,480000),
(8,'DIVYA',33,'FEMALE','CHENNAI',780,850000),
(9,'VIKRAM',27,'MALE','ERODE',660,420000),
(10,'LATHA',48,'FEMALE','VELLORE',600,390000),
(11,'RAVI',36,'MALE','CHENNAI',710,650000),
(12,'KAVITHA',31,'FEMALE','BANGALORE',690,520000),
(13,'AJAY',42,'MALE','HOSUR',730,800000),
(14,'UMA',55,'FEMALE','SALEM',580,300000),
(15,'MANOJ',34,'MALE','COIMBATORE',770,950000),
(16,'SARANYA',26,'FEMALE','CHENNAI',720,480000),
(17,'NAVEEN',39,'MALE','TRICHY',640,410000),
(18,'POOJA',41,'FEMALE','MADURAI',620,360000),
(19,'KUMAR',47,'MALE','ERODE',700,550000),
(20,'REKHA',30,'FEMALE','VELLORE',680,470000),
(21,'SANJAY',52,'MALE','SALEM',610,420000),
(22,'SHOBHA',37,'FEMALE','CHENNAI',750,780000),
(23,'PRAVEEN',29,'MALE','BANGALORE',695,500000),
(24,'HEMA',44,'FEMALE','COIMBATORE',630,460000),
(25,'BALAJI',38,'MALE','TRICHY',720,670000)
SELECT * FROM CUSTOMERS

CREATE TABLE LOANS (
    LOAN_ID INT PRIMARY KEY,
    CUSTOMER_ID INT,
    LOAN_TYPE VARCHAR(30),
    LOAN_AMOUNT INT,
    INTEREST_RATE FLOAT,
    LOAN_STATUS VARCHAR(20),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(CUSTOMER_ID)
)

INSERT INTO LOANS VALUES
(101,1,'HOME LOAN',2500000,8.5,'APPROVED'),
(102,2,'PERSONAL LOAN',300000,12.5,'REJECTED'),
(103,3,'HOME LOAN',4500000,8.2,'APPROVED'),
(104,4,'EDUCATION LOAN',600000,9.0,'APPROVED'),
(105,5,'PERSONAL LOAN',200000,13.0,'REJECTED'),
(106,6,'CAR LOAN',500000,9.5,'APPROVED'),
(107,7,'HOME LOAN',1800000,8.9,'APPROVED'),
(108,8,'HOME LOAN',5200000,7.9,'APPROVED'),
(109,9,'PERSONAL LOAN',250000,12.8,'REJECTED'),
(110,10,'EDUCATION LOAN',400000,9.2,'APPROVED'),
(111,11,'CAR LOAN',650000,9.1,'APPROVED'),
(112,12,'HOME LOAN',3000000,8.4,'APPROVED'),
(113,13,'BUSINESS LOAN',1500000,10.5,'APPROVED'),
(114,14,'PERSONAL LOAN',180000,13.5,'REJECTED'),
(115,15,'HOME LOAN',4800000,8.0,'APPROVED'),
(116,16,'CAR LOAN',550000,9.6,'APPROVED'),
(117,17,'PERSONAL LOAN',220000,12.9,'REJECTED'),
(118,18,'EDUCATION LOAN',350000,9.3,'APPROVED'),
(119,19,'HOME LOAN',2600000,8.6,'APPROVED'),
(120,20,'CAR LOAN',480000,9.4,'APPROVED'),
(121,21,'PERSONAL LOAN',200000,13.1,'REJECTED'),
(122,22,'BUSINESS LOAN',1700000,10.2,'APPROVED'),
(123,23,'HOME LOAN',2800000,8.5,'APPROVED'),
(124,24,'EDUCATION LOAN',450000,9.1,'APPROVED'),
(125,25,'CAR LOAN',700000,9.0,'APPROVED')

SELECT * FROM LOANS

CREATE TABLE PAYMENTS (
    PAYMENT_ID INT PRIMARY KEY,
    LOAN_ID INT,
    PAYMENT_DATE DATE,
    PAYMENT_AMOUNT INT,
    PAYMENT_STATUS VARCHAR(20),
    FOREIGN KEY (LOAN_ID) REFERENCES LOANS(LOAN_ID)
)

INSERT INTO PAYMENTS VALUES
(1,101,'2024-01-10',25000,'PAID'),
(2,102,'2024-01-12',0,'MISSED'),
(3,103,'2024-01-15',42000,'PAID'),
(4,104,'2024-01-18',15000,'PAID'),
(5,105,'2024-01-20',0,'MISSED'),
(6,106,'2024-01-22',18000,'PAID'),
(7,107,'2024-01-25',20000,'PAID'),
(8,108,'2024-01-27',45000,'PAID'),
(9,109,'2024-01-29',0,'MISSED'),
(10,110,'2024-02-01',12000,'PAID'),
(11,111,'2024-02-03',16000,'PAID'),
(12,112,'2024-02-05',28000,'PAID'),
(13,113,'2024-02-07',35000,'PAID'),
(14,114,'2024-02-09',0,'MISSED'),
(15,115,'2024-02-11',48000,'PAID'),
(16,116,'2024-02-13',17000,'PAID'),
(17,117,'2024-02-15',0,'MISSED'),
(18,118,'2024-02-17',14000,'PAID'),
(19,119,'2024-02-19',26000,'PAID'),
(20,120,'2024-02-21',16000,'PAID'),
(21,121,'2024-02-23',0,'MISSED'),
(22,122,'2024-02-25',32000,'PAID'),
(23,123,'2024-02-27',30000,'PAID'),
(24,124,'2024-03-01',15000,'PAID'),
(25,125,'2024-03-03',18000,'PAID');

SELECT * FROM PAYMENTS

-- 1.SELECT 

-- GET ALL CUSTOMER DATA
SELECT * FROM CUSTOMERS

-- GET ONLY REQUIRED COLUMNS
SELECT CUSTOMER_NAME, GENDER, CREDIT_SCORE FROM CUSTOMERS

-- LOAN SUMMARY
SELECT LOAN_ID, LOAN_TYPE, LOAN_AMOUNT, LOAN_STATUS FROM LOANS

-- 2.WHERE

-- CUSTOMERS WITH LOW CREDIT SCORE
SELECT * FROM CUSTOMERS CUSTOMER_NAME WHERE CREDIT_SCORE <=700 

-- APPROVED HOME LOANS ONLY
SELECT * FROM LOANS WHERE LOAN_TYPE = 'HOME LOAN' AND LOAN_STATUS = 'APPROVED'

-- MISSED PAYMENTS
SELECT * FROM PAYMENTS WHERE PAYMENT_STATUS = 'MISSED'

-- MULTIPLE CONDITIONS
SELECT CUSTOMER_NAME, CITY, CREDIT_SCORE FROM CUSTOMERS WHERE CITY = 'CHENNAI'
  AND CREDIT_SCORE >= 700

-- 3.DISTINCT (REMOVE DUPLICATES)

-- UNIQUE CITIES WHERE CUSTOMERS LIVE
SELECT DISTINCT CITY FROM CUSTOMERS

-- UNIQUE LOAN TYPES 
SELECT DISTINCT LOAN_TYPE
FROM LOANS

-- UNIQUE PAYMENT STATUS VALUES
SELECT DISTINCT PAYMENT_STATUS
FROM PAYMENTS

-- 4.ORDER BY (PRIORITIZATION & RANKING)
-- HIGHEST CREDIT SCORE FIRST
SELECT CUSTOMER_NAME, CREDIT_SCORE
FROM CUSTOMERS
ORDER BY CREDIT_SCORE DESC

-- LOWEST CREDIT SCORE FIRST (HIGH RISK FIRST)
SELECT CUSTOMER_NAME, CREDIT_SCORE
FROM CUSTOMERS
ORDER BY CREDIT_SCORE ASC

-- LARGEST LOAN AMOUNTS
SELECT LOAN_ID, LOAN_AMOUNT
FROM LOANS
ORDER BY LOAN_AMOUNT DESC

-- 5.TOP(LIMIT)
-- TOP 5 HIGH CREDIT SCORE CUSTOMERS
SELECT TOP 5 CUSTOMER_NAME, CREDIT_SCORE
FROM CUSTOMERS
ORDER BY CREDIT_SCORE DESC;

-- TOP 3 HIGHEST LOANS
SELECT TOP 3 LOAN_ID, LOAN_AMOUNT
FROM LOANS
ORDER BY LOAN_AMOUNT DESC

-- 6.AGGREGATE FUNCTIONS
-- TOTAL NUMBER OF CUSTOMERS
SELECT COUNT(*) AS TOTAL_CUSTOMERS
FROM CUSTOMERS;

-- AVERAGE CREDIT SCORE
SELECT AVG(CREDIT_SCORE) AS AVG_CREDIT_SCORE
FROM CUSTOMERS;

-- TOTAL LOAN AMOUNT
SELECT SUM(LOAN_AMOUNT) AS TOTAL_LOAN_AMOUNT
FROM LOANS;

-- MIN AND MAX CREDIT SCORE
SELECT MIN(CREDIT_SCORE) AS MIN_SCORE,
       MAX(CREDIT_SCORE) AS MAX_SCORE
FROM CUSTOMERS

-- 7.GROUP BY (SEGMENTATION)
-- NUMBER OF CUSTOMERS PER CITY
SELECT CITY, COUNT(*) AS TOTAL_CUSTOMERS
FROM CUSTOMERS
GROUP BY CITY;

-- TOTAL LOAN AMOUNT BY LOAN TYPE
SELECT LOAN_TYPE, SUM(LOAN_AMOUNT) AS TOTAL_AMOUNT
FROM LOANS
GROUP BY LOAN_TYPE

-- 8.HAVING (FILTER AFTER AGGREGATION)
-- LOAN TYPES WITH MORE THAN 3 LOANS
SELECT LOAN_TYPE, COUNT(*) AS TOTAL_LOANS
FROM LOANS
GROUP BY LOAN_TYPE
HAVING COUNT(*) > 3;

-- CITIES WITH HIGH CREDIT AVERAGE
SELECT CITY, AVG(CREDIT_SCORE) AS AVG_SCORE
FROM CUSTOMERS
GROUP BY CITY
HAVING AVG(CREDIT_SCORE) >= 700

-- 9.CASE WHEN
-- CREDIT RISK CLASSIFICATION
SELECT CUSTOMER_NAME, CREDIT_SCORE,
CASE
    WHEN CREDIT_SCORE >= 750 THEN 'LOW RISK'
    WHEN CREDIT_SCORE BETWEEN 650 AND 749 THEN 'MEDIUM RISK'
    ELSE 'HIGH RISK'
END AS RISK_LEVEL
FROM CUSTOMERS

-- TYPES OF JOINS
-- INNER JOIN (RETURNS ONLY MATCHING RECORDS IN BOTH TABLES)
-- CUSTOMERS WHO ACTUALLY HAVE LOANS
SELECT
    C.CUSTOMER_NAME,
    L.LOAN_TYPE,
    L.LOAN_AMOUNT
FROM CUSTOMERS C
INNER JOIN LOANS L
    ON C.CUSTOMER_ID = L.CUSTOMER_ID

-- LEFT JOIN (RETURNS ALL RECORDS FROM LEFT TABLE + MATCHING FROM RIGHT)
-- ALL LOANS AND THEIR PAYMENT STATUS (EVEN IF PAYMENT MISSING)
SELECT
    L.LOAN_ID,
    L.LOAN_TYPE,
    P.PAYMENT_STATUS
FROM LOANS L
LEFT JOIN PAYMENTS P
    ON L.LOAN_ID = P.LOAN_ID

-- RIGHT JOIN (RETURNS ALL RECORDS FROM RIGHT TABLE + MATCHING FROM LEFT)
SELECT
    C.CUSTOMER_NAME,
    L.LOAN_ID
FROM CUSTOMERS C
RIGHT JOIN LOANS L
    ON C.CUSTOMER_ID = L.CUSTOMER_ID

-- SELF JOIN JOIN A TABLE WITH ITSELF
-- CUSTOMERS FROM SAME CITY COMPARED TO EACH OTHER
SELECT
    A.CUSTOMER_NAME AS CUSTOMER_1,
    B.CUSTOMER_NAME AS CUSTOMER_2,
    A.CITY
FROM CUSTOMERS A
INNER JOIN CUSTOMERS B
    ON A.CITY = B.CITY
   AND A.CUSTOMER_ID <> B.CUSTOMER_ID;

-- BASIC SUBQUERIES
-- SUBQUERY IN WHERE FIND CUSTOMERS WITH REJECTED LOANS
SELECT CUSTOMER_NAME
FROM CUSTOMERS
WHERE CUSTOMER_ID IN (
    SELECT CUSTOMER_ID
    FROM LOANS
    WHERE LOAN_STATUS = 'REJECTED'
)


-- SUBQUERY WITH AGGREGATE CUSTOMERS WHO TOOK LOANS ABOVE AVERAGE LOAN AMOUNT
SELECT LOAN_ID, LOAN_AMOUNT
FROM LOANS
WHERE LOAN_AMOUNT > (
    SELECT AVG(LOAN_AMOUNT)
    FROM LOANS
);

-- SUBQUERY IN SELECT (SCALAR SUBQUERY)
-- SHOW CUSTOMER WITH TOTAL LOANS COUNT
SELECT
    CUSTOMER_NAME,
    (SELECT COUNT(*)
     FROM LOANS L
     WHERE L.CUSTOMER_ID = C.CUSTOMER_ID) AS TOTAL_LOANS
FROM CUSTOMERS C;

-- SUBQUERY IN FROM CLAUSE FILTER HIGH VALUE LOANS
SELECT *
FROM (
    SELECT LOAN_ID, LOAN_AMOUNT
    FROM LOANS
    WHERE LOAN_AMOUNT > 1000000
) AS HIGH_VALUE_LOANS;


-- EXISTS (BETTER THAN IN FOR LARGE DATA)
-- CUSTOMERS WHO HAVE AT LEAST ONE MISSED PAYMENT
SELECT DISTINCT C.CUSTOMER_NAME
FROM CUSTOMERS C
WHERE EXISTS (
    SELECT 1
    FROM LOANS L
    INNER JOIN PAYMENTS P
        ON L.LOAN_ID = P.LOAN_ID
    WHERE L.CUSTOMER_ID = C.CUSTOMER_ID
      AND P.PAYMENT_STATUS = 'MISSED'
)




